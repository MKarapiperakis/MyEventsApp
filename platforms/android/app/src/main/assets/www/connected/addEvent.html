<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <!-- <script src="../scripts/maps.js"></script> -->



  <title>Προσθήκη εκδήλωσης</title>
  <link rel="icon" type="image/x-icon" href="../logo/icon.ico">
  <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/navbar-fixed/">
  <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
  <link rel="icon" type="image/x-icon" href="../logo\icon.ico">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script src="../js/validate.js" async=""></script>



  <link href="../css/style.css" rel="stylesheet">
  <link href="../css/signin.css" rel="stylesheet">
  <link href="../css/addEvent.css" rel="stylesheet">

  <style>
    body {
      padding-top: 100px;
      height: 800px;
    }
  </style>
  <link href="../css/network.css" rel="stylesheet">

</head>

<body class="text-center">
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark" id="nav">
    <div class="container-fluid">
      <!--<a class="navbar-brand active"   onclick="scrollToTop()" onmouseover="logoHover()" id = "logo">My Events</a>-->

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
        aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
        <ul class="navbar-nav ">

        </ul>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Νέα εκδήλωση</a>
          </li>
          <li class="nav-item">
            <a class="nav-link " aria-current="page" href="showEvents.html">Εκδηλώσεις</a>
          </li>
          <li class="nav-item">
            <a class="nav-link " aria-current="page" href="nearEvents.html">Κοντινές εκδηλώσεις</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="javascript:end();">Αποσύνδεση</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main>

    <div class="offline" id="offline">
      <img src="../images/no-wifi.png">
    </div>


    <form class="text-left mx-auto card " id="form" autocomplete="off">
      <h1 class="h3 mb-3 text-center">Προσθήκη Εκδήλωσης</h1>



      <div class="form-floating">
        <input type="text" name="title" id="title" class="form-control mb-4  " placeholder="title" maxLength="30">
        <label for="floatingInput" class="text-start ms-0">Τίτλος Εκδήλωσης</label>
      </div>

      <div class="form-floating">
        <input type="number" pattern="[0-9]*" inputmode="numeric" name="phone" id="phone" class="form-control mb-4  "
          placeholder="phone" maxLength="20">
        <label for="floatingInput" class="text-start ms-0">Τηλέφωνο Επικοινωνίας</label>
      </div>

      <div class="form-floating">
        <textarea class="form-control" id="description" maxlength="100" placeholder="description"></textarea>
        <label class="form-label" for="textAreaExample">Λεπτομέρειες</label>
      </div>

      <label class="text-start ms-0 mt-1 mb-0" style="color: #0d6efd;">Ώρα έναρξης:</label>
      <div class="cs-form">
        <input type="time" id=time class="form-control" />
      </div>

      <label class="text-start ms-0 mt-1 mb-0" style="color: #0d6efd;">Επιλογή κατηγορίας:</label>
      <select class="form-select mt-1" id="category">
        <option>Σινεμά</option>
        <option>Θέατρο</option>
        <option>Μουσική</option>
        <option>Εκθέσεις</option>
        <option>Αθλητισμός</option>
        <option>Ομιλία</option>
        <option>Άλλο</option>
      </select>

      <label class="text-start ms-0 mt-1 mb-0" style="color: #0d6efd;">Είσοδος:</label>

      <div class="form-check" align="left">
        <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios1" value="option1" checked
          onchange="handleChange(this);">
        <label class="form-check-label" for="exampleRadios1">
          Ελεύθερη
        </label>
      </div>
      <div class="form-check" align="left">
        <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios2" value="option2"
          onchange="handleChange(this);">
        <label class="form-check-label" for="exampleRadios2">
          Επί πληρωμή
        </label>
      </div>

      <div class="form-floating" style="display: none" id="pay">
        <input type="number" pattern="[0-9]*" inputmode="numeric" name="payment" id="payment"
          class="form-control mb-4  " placeholder="payment" maxLength="15" value=0>
        <label for="floatingInput" class="text-start ms-0">Ποσό πληρωμής</label>
      </div>





      <button class="btn btn-lg btn-primary w-100 mt-3" type="submit" id="cont" onclick="test2(event)">
        Συνέχεια
      </button>





    </form>





    <form class="text-right mx-auto card " id="infoForm" autocomplete="off"
      style="position: absolute; background-color: transparent;border: 0px;width: 98%">

      <h1 id="mapHeader" style="display: none">Επιλογή χώρου</h1>
      <div class="row justify-content-center ">
        <div class="col-auto " id="map" style="display: none">

        </div>
        <div class="col-auto" id="informations" style="display: none">
          <h3>Πληροφορίες</h3>
          <table class="table table-striped table-dark">

            <tbody>
              <tr>
                <th scope="row">Όνομα Ιδιοκτήτη</th>
                <td id="owner"></td>
              </tr>
              <tr>
                <th scope="row">Τηλέφωνο Επικοινωνίας</th>
                <td id="contact"></td>
              </tr>
              <tr>
                <th scope="row">Έκταση χώρου</th>
                <td id="area"></td>
              </tr>
              <tr>
                <th scope="row">Λεπτομέρειες</th>
                <td><textarea class="form-control" id="details" rows="4" readonly></textarea></td>
              </tr>
              <tr>
                <th>Διαθεσιμότητα</th>
                <td><input type="text" id="datepicker" onclick="date()" maxlength=0; readonly></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>


      <button class="btn btn-lg btn-primary w-50 mt-2 " type="submit" id="save"
        style="display: none;margin-left: 25vw;margin-top: 20%;position: relative;" onclick="savePlace(event)">
        Αποθήκευση
      </button>
    </form>





    <!-- Modal HTML -->
    <div id="myModal" class="modal fade">
      <div class="modal-dialog modal-confirm">
        <div class="modal-content">
          <div class="modal-header justify-content-center">
            <div class="icon-box">
              <i class="material-icons">&#xE5CD;</i>
            </div>
            <!--<button type="button" class="close" data-dismiss="modal" aria-hidden="true" onclick = "error()" style = "background: transparent;border: 0px;">&times;</button>-->
          </div>
          <div class="modal-body text-center">
            <h4>Σφάλμα!</h4>
            <p>Πρέπει να επιλέξεις ημερομηνία και ώρα που θα λάβει χώρα η εκδήλωσή σου.</p>
            <button class="btn btn-success" data-dismiss="modal" onclick="error()">ΟΚ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal2 -->
    <div class="modal fade" id="myModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel" align: center>Επιτυχής προσθήκη</h5>

          </div>
          <div class="modal-body">
            Ο νέος χώρος εκδήλωσης προστέθηκε με επιτυχία.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="success()">ΟΚ</button>
          </div>
        </div>
      </div>
    </div>

  </main>


  <script type="text/javascript" src="../cordova.js"></script>
  <script src="../assets/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/ready.js" async=""></script>
  <script src="../js/network_status.js" async=""></script>
  <script>





    //alert(localStorage.getItem("Name"));

    var placeId;
    setInterval(getDate, 1000);

    var placeIdList = [];
    var dateList = [];
    var disabledDates = [];

    function end() {
      localStorage.clear();
      window.location.replace("../sign_in.html");
    }

    function getDate() {
      //alert("here");
      url = "http://myuopevents.com/php/getAvailability.php";
      placeIdList = [];
      dateList = [];
      $.ajax({
        type: "GET", crossDomain: true, cache: false,
        url: url,
        dataType: 'jsonp',
        jsonp: "callback",
        success: function (data) {
          disabledDates = [];
          var len = data.length;

          for (var i = 0; i < len; i++) {
            placeIdList.push(data[i].placeID);
            dateList.push(data[i].selectedDate);
          }

          if (placeId != null)      //if user select a marker
          {

            for (var i = 0; i < placeIdList.length; i++) {
              if (placeIdList[i] == placeId) {

                disabledDates.push(dateList[i]);
              }


            }
            //alert(disabledDates);
            $("#datepicker").datepicker({
              minDate: 0,                                      //disable past dates
              beforeShowDay: function (date) {                  //disable unavailable dates
                var string = jQuery.datepicker.formatDate('mm/dd/yy', date);
                return [disabledDates.indexOf(string) == -1]
              }


            });

            $("#datepicker").datepicker("refresh");       //Redraw the date picker, after having made some external modifications.
          }

        }//end of success
      }); //end of ajax
    } //end of function

    function error() {
      $('#myModal').modal('hide');
    }

    function success() {
      location.reload();
    }

    function handleChange(src) {
      //alert(src.value);
      if (src.value == "option2") {
        document.getElementById("pay").style.display = "block";
      }
      else {
        document.getElementById("pay").style.display = "none";
        document.getElementById("payment").value = 0;
      }
    }




    function savePlace(event) {
      event.preventDefault();
      //alert("save?");
      var name = localStorage.getItem("Name");
      var title = document.getElementById("title").value;
      var phone = document.getElementById("phone").value;
      var description = document.getElementById("description").value;
      var category = document.getElementById("category").value;
      var payment = document.getElementById("payment").value;
      var date = document.getElementById("datepicker").value;
      var time = document.getElementById("time").value;
      //alert(time);

      if (date == "" || time == "") {
        $('#myModal').modal('show');
      }
      else    //we are ready to add the event
      {
        var url = "http://myuopevents.com/php/cordovaAddEvent.php";
        var url2 = "http://myuopevents.com/php/cordovaAddAvailability.php";





        var dataString = "name=" + name + "&title=" + title + "&phone=" + phone + "&description=" + description + "&category=" + category + "&payment=" + payment + "&date=" + date + "&placeId=" + placeId + "&time=" + time;
        var dataString2 = "date=" + date + "&placeId=" + placeId;

        $.ajax({
          type: "GET", crossDomain: true, cache: false,
          url: url,
          data: dataString,
          dataType: 'jsonp',
          jsonp: "callback",
          success: function (data) {
            if (data[0].answer == "success") {
              $.ajax({
                type: "GET", crossDomain: true, cache: false,
                url: url2,
                data: dataString,
                dataType: 'jsonp',
                jsonp: "callback",
                success: function (data2) {
                  if (data2[0].answer == "success") {
                    //alert("success");
                    $('#myModal2').modal('show');
                    // location.reload();
                  }
                  else {
                    alert("error in 2nd Ajax");
                  }
                } //end of 2nd success
              }); //end of 2nd Ajax
            }
            else {
              alert("error in 1st Ajax");

            }

          }//end of 1st success
        }); //end of 1st AJAX

      }
    }
    //setInterval( test, 4000 );  


    let map;

    function test2(event) {
      event.preventDefault();
      document.getElementById("map").style.display = "block";
      document.getElementById("mapHeader").style.display = "block";
      document.getElementById("cont").style.display = "none";
      document.getElementById("save").style.display = "block";
      document.getElementById("save").scrollIntoView(true);
      document.getElementById("save").style.padding = "0%";
      document.getElementById("save").style.visibility = "hidden";
      //document.getElementById("informations").style.display = "block";

      latitude = 39.617607961516065;
      longitude = 22.69325295563209;
      selected_zoom = 7;

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: latitude, lng: longitude },
        zoom: selected_zoom,
        disableDefaultUI: true,
        zoomControl: true,
        mapTypeControl: true,
        streetViewControl: true,
        overviewMapControl: true,
        gestureHandling: 'greedy'
      });

      test();
    }

    function test() {

      var lat1List = [];
      var lat2List = [];
      var lat3List = [];
      var lat4List = [];
      var long1List = [];
      var long2List = [];
      var long3List = [];
      var long4List = [];
      var marklatList = [];
      var marklongList = [];
      var descriptionList = [];
      var phoneList = [];
      var nameList = [];
      var maptypeList = [];
      var idList = [];
      var areaSizeList = [];
      var url = "http://myuopevents.com/php/getPlace.php";



      $.ajax({
        type: "GET",
        url: url,
        dataType: 'jsonp',
        jsonp: "callback",

        success: function (data) {

          var len = data.length;



          for (var i = 0; i < len; i++) {
            lat1List.push(data[i].lat1);
            lat2List.push(data[i].lat2);
            lat3List.push(data[i].lat3);
            lat4List.push(data[i].lat4);
            long1List.push(data[i].long1);
            long2List.push(data[i].long2);
            long3List.push(data[i].long3);
            long4List.push(data[i].long4);
            marklatList.push(data[i].marklat);
            marklongList.push(data[i].marklong);
            descriptionList.push(data[i].descr);
            phoneList.push(data[i].phone);
            nameList.push(data[i].name);
            maptypeList.push(data[i].maptype);
            idList.push(data[i].id);
            areaSizeList.push(data[i].areaSize);
          }   //end of loop





          for (var i = 0; i < marklatList.length; i++) {

            if (maptypeList[i] == "default")     //simple marker
            {
              latitude = parseFloat(marklatList[i]);
              longitude = parseFloat(marklongList[i]);

              var marker = new google.maps.Marker({
                position: { lat: latitude, lng: longitude },
                title: idList[i],
                animation: google.maps.Animation.DROP
              });

              marker.setMap(map);

              //every time i click a marker, i have his id
              google.maps.event.addListener(marker, 'click', (function (marker, i) {
                return function () {

                  placeId = marker.title;
                  document.getElementById("save").style.visibility = "visible";
                  var num;
                  for (var i = 0; i < idList.length; i++) {
                    if (idList[i] == marker.title)
                      num = i;

                  }

                  if (nameList[num] != "")
                    document.getElementById("owner").innerHTML = nameList[num];
                  else
                    document.getElementById("owner").innerHTML = "χωρίς όνομα";

                  if (phoneList[num] != "0")
                    document.getElementById("contact").innerHTML = phoneList[num];
                  else
                    document.getElementById("contact").innerHTML = "χωρίς τηλέφωνο";

                  if (areaSizeList[num] != "")
                    document.getElementById("area").innerHTML = "";
                  else
                    document.getElementById("area").innerHTML = "";

                  if (descriptionList[num] != "")
                    document.getElementById("details").innerHTML = (descriptionList[num]);
                  else
                    document.getElementById("details").innerHTML = "χωρίς λεπτομέρειες";

                  /*var disabledDates = ["2015-11-28","2015-11-14","2022-07-28"]

                 $("#datepicker").datepicker({
                     minDate: 0,     //disable past dates
                     beforeShowDay: function(date){  //disable anavailable dates
                         var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
                         return [ disabledDates.indexOf(string) == -1 ]
                     }
                 });
                 */

                  document.getElementById("informations").style.display = "block";
                  var pref_zoom = map.getZoom();
                  map.setZoom(pref_zoom + 3);
                  map.setCenter(marker.position);

                }
              })(marker, i));
            }
            else if (maptypeList[i] == "custom")   //polygon
            {
              //alert(i);
              const Coords = [
                { lat: parseFloat(lat1List[i]), lng: parseFloat(long1List[i]) },
                { lat: parseFloat(lat2List[i]), lng: parseFloat(long2List[i]) },
                { lat: parseFloat(lat3List[i]), lng: parseFloat(long3List[i]) },
                { lat: parseFloat(lat4List[i]), lng: parseFloat(long4List[i]) },
              ];
              // Construct the polygon.
              const Event = new google.maps.Polygon({
                paths: Coords,
                strokeColor: "#FF0000",
                strokeOpacity: 0.3,
                strokeWeight: 1,
                fillColor: "#FF0000",
                fillOpacity: 0.4,
              });

              Event.setMap(map);


              latitude = parseFloat(marklatList[i]);
              longitude = parseFloat(marklongList[i]);

              var marker = new google.maps.Marker({
                position: { lat: latitude, lng: longitude },
                title: idList[i],
                icon: "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png",
                animation: google.maps.Animation.DROP
              });

              marker.setMap(map);


              google.maps.event.addListener(marker, 'click', (function (marker, i) {
                return function () {

                  placeId = marker.title;
                  document.getElementById("save").style.visibility = "visible";
                  //alert(marker.title);
                  var num;
                  for (var i = 0; i < idList.length; i++) {
                    if (idList[i] == marker.title)
                      num = i;

                  }

                  if (nameList[num] != "")
                    document.getElementById("owner").innerHTML = nameList[num];
                  else
                    document.getElementById("owner").innerHTML = "χωρίς όνομα";

                  if (phoneList[num] != "0")
                    document.getElementById("contact").innerHTML = phoneList[num];
                  else
                    document.getElementById("contact").innerHTML = "χωρίς τηλέφωνο";

                  if (areaSizeList[num] != "")
                    document.getElementById("area").innerHTML = parseInt(areaSizeList[num]) + " τετραγωνικά μέτρα";
                  else
                    document.getElementById("area").innerHTML = "<strong></strong>";

                  if (descriptionList[num] != "")
                    document.getElementById("details").innerHTML = (descriptionList[num]);
                  else
                    document.getElementById("details").innerHTML = "χωρίς λεπτομέρειες";



                  document.getElementById("informations").style.display = "block";
                  var pref_zoom = map.getZoom();
                  map.setZoom(pref_zoom + 3);
                  map.setCenter(marker.position);

                }
              })(marker, i));
            }
          }


        }   //end of success
      });    //end of AJAX


    }


  </script>

















  <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-PFGebXOOGaS42g1pRa7TO_HNMbK5p5k&callback=initMap">
    </script>
</body>

</html>